---
title: 'fitgrid: A Python package for multi-channel event-related time series regression modeling'
tags:
  - Python
  - EEG electroencephalography
  - MEG magnetoencephalography
  - ERP rERP
  - linear regression
  - ordinary least squares
  - linear mixed-effects
  - exploratory data analysis EDA
authors:
  - name: Thomas P. Urbach^[corresponding author, turbach@ucsd.edu]
    orcid: 0000-0001-7993-142X
    affiliation: 1
  - name: Andrey S. Portnoy
    affiliation: 2
affiliations:
 - name: Department of Cognitive Science, University of California, San Diego
   index: 1
 - name: Cerebras Systems
   index: 2
date: 10 February 2021
bibliography: paper.bib
---

# Summary

Electroencephalography (EEG) and magnetoencephalography (MEG) are
non-invasive human brain imaging modalities with millisecond temporal
resolution that track the time course of electromagnetic fields
generated by the synchronous activity of populations of neurons as the
brain dynamically processes information. A central challenge for
research is that the fields systematically related to events under
experimental control are generally small relative to much larger
fields generated by unrelated ongoing brain activity, often differing
by one or more orders of magnitude.

In the early 1950s Dawson demonstrated that brain responses to sensory
stimulation that were too small to see in wideband EEG could be
detected by aligning several recordings with the delivery of the
stimulus and averaging the values at each point in time
[@Dawson1951; @Dawson1954]. As the average accumulates, irregular
fluctuations (noise) in the individual recordings tend to cancel out
and reveal the time-course of the much smaller stimulus-related
response (signal). Dawson attributed the suggestion to J. N. Hunt,
noting that while the application to EEG recordings was novel, the
approach was generally well-known and an adaptation of Laplace's
(unsuccessful) 19th century attempt to detect tiny but regular lunar
atmospheric tides among the much larger irregular pressure
fluctuations [see, e.g., @LinCha1969]. Hunt-Dawson time-domain
averaging was a breakthrough. In subsequent decades, laboratory
experiments showed that whereas EEG is typically around 25 - 75 $\mu$V
peak to peak, for $n$ on the order of 10 to 1000, sweeping an averager
across the $n$ time-aligned EEG recordings revealed transient and
steady-state brain responses down to fractions of a microvolt over a
wide range of frequencies before, during, and after sensory
stimulation, motor responses, and internal mental
events. Oscilloscopic sweep averagers gave way to multi-channel
analog-to-digital data acquisition and sum-and-divide-by-$n$ averaging
in software on general purpose computers. Since the 1970s, the
resulting *discrete time-domain average event-related brain potential*
or ERP has been a cornerstone of experimental brain research on human
sensation, perception, and cognition [@LucKap2013].

In a seminal paper, Smith and Kutas noted that the average of a set of
values, $y$, is identical to the estimated constant $\hat{\beta}_{0}$
for the linear model $y = \beta_{0} + \varepsilon$, fit by minimizing
squared error [@SmiKut2015]. They pointed out that this makes the
sum-and-divide time-domain average ERP at time $t$ mathematically
identical to $\hat\beta_{0}(t)$ and a special case of sweeping a
linear regression model along the EEG. Generalizing to more complex
models, e.g., multiple regression $y(t) = \beta_{0} + \beta_{1}X_{1} +
\ldots + \beta_{p}X_{p} + \varepsilon$, likewise produces time series of
estimates for the intercept and each regressor coefficient, the
$\hat{\beta}_{0}(t), \hat{\beta}_{1}(t), \ldots, \hat{\beta}_{p}(t)$
they dubbed regression ERP (rERP) waveforms.  This holds for
straight-line fits ("slope" rERPs) as well as models of curvilinear
relationships, e.g., spline regression [@SmiKut2015b]. Still more
generally, the approach produces time series for all the basic and
derived quantities of the fitted model: parameter estimates and their
standard errors, residuals, residual error, likelihood, Akaike
information criterion (AIC), and so forth.

The insight that sum-and-divide averaging is special case of
regression modeling steps back from Laplace-Hunt-Dawson "needle in a
haystack" signal detection and locates event-related EEG data analysis
the general framework of applied regression for fitting, evaluating,
and comparing a range of models to account for systematic variation in
the time course of the brain responses
[see @SmiKut2015; @SmiKut2015b for discussion of related approaches]. With
this shift, however, comes a new problem.

# Statement of need

Fitting a regression model is relatively straightforward on any
current scientific computing platform. Informative modeling, by
contrast, is a laborious process that iterates cycles of data quality
control, fitting, data diagnosis, model evaluation, comparison,
selection, and interpretation with numerous decision points that
require thought and judgment.

Modeling digitized multichannel EEG data as regression ERPs at each
time point and data channel multiplies the iterative cycles in a
combinatorial explosion of times $\times$ channels $\times$ models
$\times$ comparisons. For instance, at a digital sampling rate of 250
samples per second, in 3 seconds of 32-channel EEG data there are
24,000 data sets (= 3 $\times$ 250 $\times$ 32). To fit a set of three
candidate models requires 72,000 separate model fits, where the size
of each data set might range anywhere from a few dozens of
observations for a single subject to tens of thousands of observations
for a large scale experiment. Nothing can prevent the combinatorial
explosion; `fitgrid` is designed to contain it.

Although the rERP approach is attracting growing attention in the
field, to date the open-source EEG and MEG data analysis landscape
has been dominated by toolboxes written for MATLAB such as EEGLAB
[@DelMak2004], FieldTrip [@OosEtAl2011], and Brainstorm
[@TadEtAl2011], and this holds for rERP modeling, e.g., @EhiDim2019.
Like open-source scientific computing generally, Python and R have
been gaining traction for EEG and MEG analysis, as in MNE Python
@GramfortEtAl2013 and for regression ERPs in R,
@TreNew2015. Nevertheless, widely accessible implementations for rERP
modeling in the Python remain limited.  Development of N. J. Smith's
promising rERPy Python package for ERP and rERP analysis appears to
have halted in Python 2.X. MNE Python implements a
`linear_regression` function for computing rERP coefficients on
continuous data as described in @SmiKut2015b but not time series of
OLS or mixed-effects model fits.

# fitgrid


`fitgrid` is intended to fill this gap and make rERP modeling as
presented in @SmiKut2015 accessible to researchers with a working
knowledge of scripted data analysis in Python and the symbolic
formulae such as $\mathsf{\sim 1 + a + b + a:b}$ and $\mathsf{\sim 1 +
a*b + (a|s) + (a|i) }$ currently in wide use to specify ordinary and
mixed-effects models in Python and R
[`patsy` @patsy; `lme4::lmer` @BatesEtAl2015; `lm` @Rproject]. The
`fitgrid` user interface launches what are routinely hundreds to tens
of thousands of model fits with one line of code (computed in parallel
if supported by hardware). The fit results across times and channels
are available on demand with the same syntax used to access results in
a single fit object and the results are returned as tidy indexed
`pandas.DataFrames` for further analysis, visualization, and
interpretation. While the origins of `fitgrid` are in EEG data
analysis, `fitgrid` can also be used with other neuroimaging data such
as MEG and more generally with synchronized sensor array time-series
data from other domains where event-related regression modeling is
appropriate.  `fitgrid` enables researchers to conduct this type of
computationally intensive modeling flexibly, efficiently,
informatively, and reproducibly with familiar scientific computing
tools and minimal programming. These features make `fitgrid`
well-suited for general use in exploratory data analysis (EDA), e.g.,
@UrbDelChaKut2020 and @TroUrbKut2020.

![fitgrid TL; DR](fitgrid_overview.png)


# Documentation

The `fitgrid` documentation is available online:
[https://kutaslab.github.io/fitgrid-dev]([https://kutaslab.github.io/fitgrid-dev]).

* [Getting Started]() gives an overview of the `fitgrid` workflow with
   notes, figures, and downloadable and executable code.
   
* The [User Guide]() provides information about usage and specific
  topics including how the OLS models are fit in Python `statsmodels`
  [@SeaPer2010] and the LMER models are fit in R
  [`lme4::lmer`, `lmerTest` @KuzBroChr2017] via `pymer4` [@Jolly2018].

* The [API Reference]() is a complete listing of `fitgrid` classes,
  methods, attributes, and functions auto-generated with numpy-style
  docstrings and links to the source code generated by
  ``sphinx-apidoc`` [@sphinx].

* The [Bibliography]() includes references to relevant experimental
  and technical literature.

* The [Examples Gallery]() contains `fitgrid` vignettes with simulated
  data, experimental EEG recordings, and NOAA tide and atmospheric
  observations that can be downloaded as executable Python scripts or
  Jupyter notebooks thanks to
  [sphinx-gallery](https://sphinx-gallery.github.io/).

  ![Downloadable Examples Gallery](examples_gallery.png)

## Installation, Continuous Integration, and Source 

The online documentation includes [installation instructions]() and
system recommendations.  The latest stable release of `fitgrid` and
the bleeding edge pre-release development version are packaged for
Python 3.6, 3.7, and 3.8 on x86_64 linux and distributed on Anaconda
Cloud. Installation of the stable release into a fresh conda virtual
environment along with other compatible packages, e.g., `jupyter` for
running Example Gallery notebooks, is recommended like so:

```bash
    $ conda create --name fg_env \
        -c kutaslab -c defaults -c conda-forge \
	    fitgrid jupyter
```

`fitgrid` is developed and tested locally on a high-performance
48-core x86_64 CentOS 7 server. Continuous integration (CI) with
github Actions for the latest stable release on the main code branch
runs nightly conda build, conda install, and package pytests on
Ubuntu 18.04. Pre-release packages also pass CI conda build, conda
install, and pytests before deployment to Anaconda Cloud. The
Python 3.6, 3.7 and 3.8 64-bit Intel OSX and Windows packages are also
distributed on Anaconda Conda and the Python sdist is uploaded to PyPI
but these are not routinely tested (contributed field reports are
welcome). The source code is hosted in the public github repository
[https://github.com/kutaslab/fitgrid-dev)](https://github.com/kutaslab/fitgrid-dev)
and Issues may be posted there in accordance with the `fitgrid` Code
of Conduct.


## How it works

[TODO ... Andrey]

## Limitations

In addition to straight-line fits, the `fitgrid` framework can fit OLS
models of curvilinear relations between predictors and EEG with model
formulas because `patsy` supports column variable transformation by
arbitrary Python code. Polynomial regression ERPs for U-shaped
relations can be computed with, e.g., $\mathsf{x + pow(x, 2)}$ if this
seems like a good idea. If spline regression as described in
@SmiKut2015b seems like a better idea, `patsy` also provides built-in
functions for generating families of spline bases, although the
researcher is responsible for ensuring the data epochs are
appropriately mapped to the spline regression variables which may
require additional programming. @SmiKut2015b also generalizes rERP
estimation from iteratively fitting fixed-length epochs of length $L$
at each time point to fitting continuous data with a single model. For
a design with $P$ predictor variables, this conceptually elegant
approach unstacks the $L$ times (rows) of the epoch into $\mathsf{L
\times P}$ predictor variables (columns) and codes the observation row
values as zeros or non-zeros according to the value of the predictor
at the time. The coefficients estimated by a single OLS fit are
identical to segmenting the data and fitting models with the $P$
predictors iteratively at each of the $L$ time points. In principle
`fitgrid` can ingest and fit the continuous data prepared for the wide
$L \times P$ design matrix as a corner case of single-sample epochs
but it is not a natural act and at cross-purposes in some respects. In
`fitgrid`, models are fit separately at each time and channel in order
to track the time course of all the fit attributes, not just the
estimated regression coefficients. For fitting the wide $\mathsf{L
\times P}$ models to continuous data, implementations specifically
designed for that approach such as the rERPy package or the
implementation in MNE Python may be a better choice.

# Acknowledgements and Contributions

This project was developed in the Kutas Cognitive Electrophysiology
Laboratory, Department of Cognitive Science, University of California,
San Diego. ASP designed, implemented, and named the `fitgrid` package,
user interface, classes and core routines. TPU contributed the
concept, prototypes, and utility routines. We gratefully acknowledge
contributions by Lauren Liao (prototype coding and testing), Nathaniel
J. Smith (binary EEG file I/O), and testing and feedback by Wen-Hsuan
Chan, Emily Provenzano, Anna Stoermann, and Melissa Troyer. This work
was supported by grant NICHD 5R01HD022614 to Marta Kutas.

# References
